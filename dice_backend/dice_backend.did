type RollDirection = variant {
  Over;
  Under;
};

type DiceResult = record {
  player: principal;
  bet_amount: nat64;
  target_number: nat8;
  direction: RollDirection;
  rolled_number: nat8;
  win_chance: float64;
  multiplier: float64;
  payout: nat64;
  is_win: bool;
  timestamp: nat64;
};

type GameStats = record {
  total_games: nat64;
  total_volume: nat64;
  total_payouts: nat64;
  house_profit: int64;
};

type AccountingStats = record {
  total_user_deposits: nat64;
  house_balance: nat64;
  canister_balance: nat64;
  unique_depositors: nat64;
};

type DetailedGameHistory = record {
  game_id: nat64;
  player: text;
  bet_icp: float64;
  won_icp: float64;
  target_number: nat8;
  direction: text;
  rolled_number: nat8;
  win_chance: float64;
  multiplier: float64;
  is_win: bool;
  timestamp: nat64;
  profit_loss: int64;
  expected_value: float64;
  house_edge_actual: float64;
};

type LPPosition = record {
  shares: nat;
  pool_ownership_percent: float64;
  redeemable_icp: nat;
};

type PoolStats = record {
  total_shares: nat;
  pool_reserve: nat;
  share_price: nat;
  total_liquidity_providers: nat64;
  minimum_liquidity_burned: nat;
  is_initialized: bool;
};

type DailySnapshot = record {
  day_timestamp: nat64;
  pool_reserve_end: nat64;
  daily_pool_profit: int64;
  daily_volume: nat64;
};

type ApyInfo = record {
  actual_apy_percent: float64;
  expected_apy_percent: float64;
  days_calculated: nat32;
  total_volume: nat64;
  total_profit: int64;
};

service : {
  // Play a game of dice - now with client seed for instant randomness
  play_dice: (nat64, nat8, RollDirection, text) -> (variant { Ok: DiceResult; Err: text });

  // Query functions
  get_stats: () -> (GameStats) query;
  get_recent_games: (nat32) -> (vec DiceResult) query;
  get_game: (nat64) -> (opt DiceResult) query;
  calculate_payout_info: (nat8, RollDirection) -> (variant { Ok: record { float64; float64 }; Err: text }) query;
  get_detailed_history: (nat32) -> (vec DetailedGameHistory) query;
  export_history_csv: (nat32) -> (text) query;

  // Provable fairness verification methods
  get_current_seed_hash: () -> (text) query;
  verify_game_result: (blob, text, nat64, nat8) -> (variant { Ok: bool; Err: text }) query;
  get_seed_info: () -> (text, nat64, nat64) query;

  // Accounting methods
  deposit: (nat64) -> (variant { Ok: nat64; Err: text });
  withdraw_all: () -> (variant { Ok: nat64; Err: text });
  get_balance: (principal) -> (nat64) query;
  get_my_balance: () -> (nat64) query;
  get_house_balance: () -> (nat64) query;
  get_max_allowed_payout: () -> (nat64) query;
  get_canister_balance: () -> (nat64);
  get_accounting_stats: () -> (AccountingStats) query;
  audit_balances: () -> (variant { Ok: text; Err: text }) query;
  refresh_canister_balance: () -> (nat64);

  // Liquidity Pool Management
  deposit_liquidity : (nat64) -> (variant { Ok: nat; Err: text });
  withdraw_all_liquidity : () -> (variant { Ok: nat64; Err: text });

  // LP Queries
  get_lp_position : (principal) -> (LPPosition) query;
  get_my_lp_position : () -> (LPPosition) query;
  get_pool_stats : () -> (PoolStats) query;
  get_house_mode : () -> (text) query;
  can_accept_bets : () -> (bool) query;

  // Daily Statistics
  get_daily_stats: (nat32) -> (vec DailySnapshot) query;
  get_stats_range: (nat64, nat64) -> (vec DailySnapshot) query;
  get_stats_count: () -> (nat64) query;
  get_pool_apy: (opt nat32) -> (ApyInfo) query;

  // Test function
  greet: (text) -> (text) query;
}
