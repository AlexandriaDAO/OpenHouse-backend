================================================================================
               DAOPad MAINNET-ONLY DEPLOYMENT WORKFLOW
================================================================================

CRITICAL FACTS:
- No local testing environment exists
- All testing happens on mainnet
- Frontend and backend MUST stay in sync
- Declaration sync is a known pain point (auto-handled in deploy.sh)

================================================================================
                          FILE LOCATIONS
================================================================================

PRIMARY DEPLOYMENT SCRIPT:
  /home/theseus/alexandria/daopad/src/daopad/deploy.sh (400 lines, well-documented)

CLAUDE-SPECIFIC DOCUMENTATION:
  /home/theseus/alexandria/daopad/src/daopad/CLAUDE.md (Complete workflow guide)

CANISTER CONFIGURATION:
  /home/theseus/alexandria/daopad/canister_ids.json (Mainnet IDs only)
  /home/theseus/alexandria/daopad/dfx.json (DFX config)

CLAUDE PERMISSIONS:
  /home/theseus/alexandria/daopad/src/daopad/.claude/settings.local.json

GITHUB WORKFLOWS:
  /home/theseus/alexandria/daopad/.github/workflows/claude.yml (Interactive)
  /home/theseus/alexandria/daopad/.github/workflows/claude-code-review.yml (Auto-review)

TESTING & VERIFICATION:
  /home/theseus/alexandria/daopad/src/daopad/scripts/test-deployment.sh
  /home/theseus/alexandria/daopad/src/daopad/scripts/verify-declarations.sh

================================================================================
                       STANDARD DEPLOYMENT COMMAND
================================================================================

cd /home/theseus/alexandria/daopad/src/daopad/
./deploy.sh --network ic

This single command:
1. Checks network (switches to 'daopad' identity for mainnet)
2. Builds backend (Rust compilation)
3. Extracts Candid interface
4. Deploys backend to mainnet
5. SYNCS DECLARATIONS TO FRONTEND (critical!)
6. Builds frontend (npm)
7. Deploys frontend to mainnet
8. Shows deployment summary

================================================================================
                      MAINNET CANISTER STRUCTURE
================================================================================

BACKEND CANISTER (lwsav-iiaaa-aaaap-qp2qq-cai)
  Role: Creates Orbit requests only
  Network: Mainnet only
  Dependencies: None
  Interface: Candid in src/daopad/daopad_backend/daopad_backend.did

ADMIN CANISTER (odkrm-viaaa-aaaap-qp2oq-cai)
  Role: Handles voting and approvals
  Network: Mainnet only
  Dependencies: None
  Interface: Candid in src/daopad/admin/admin.did

FRONTEND CANISTER (l7rlj-6aaaa-aaaap-qp2ra-cai)
  Role: User interface
  Network: Mainnet only
  Dependencies: daopad_backend + admin
  Type: Asset canister
  Build: npm run build

ORBIT STATION (fec7w-zyaaa-aaaaa-qaffq-cai)
  Role: External governance system
  Identity: daopad (has admin/operator access)
  Used for: Validating request formats and responses

================================================================================
                    CLAUDE DEPLOYMENT INSTRUCTIONS
================================================================================

From CLAUDE.md (Lines 1-8):

1. Deployment: Use ./deploy.sh from THIS directory (src/daopad/), NOT the root

### Workflow Summary:
./deploy.sh --network ic  # Deploy everything. Use this every time.

CRITICAL: Always deploy to mainnet using ./deploy.sh --network ic after making 
ANY changes. There is no local testing environment - all testing happens on 
mainnet. This ensures both frontend and backend stay in sync.

================================================================================
                  CRITICAL DECLARATION SYNC BUG
================================================================================

PROBLEM:
  Frontend reads declarations from:     src/daopad/daopad_frontend/src/declarations/
  DFX generates declarations to:        src/declarations/
  They don't auto-sync!

SYMPTOM:
  TypeError: actor.method_name is not a function
  (Works in dfx but fails in frontend)

SOLUTION:
  Deploy script AUTOMATICALLY handles this with:
  cp -r src/declarations/daopad_backend/* src/daopad/daopad_frontend/src/declarations/daopad_backend/

VERIFICATION:
  Run: ./scripts/verify-declarations.sh

================================================================================
                    DEPLOYMENT COMMAND OPTIONS
================================================================================

Full Deployment (both backend and frontend):
  ./deploy.sh --network ic

Backend Only:
  ./deploy.sh --network ic --backend-only

Frontend Only:
  ./deploy.sh --network ic --frontend-only

With Post-Deployment Tests:
  ./deploy.sh --network ic --test

Fresh Local Deployment:
  ./deploy.sh --fresh

Fresh Local Backend:
  ./deploy.sh --fresh --backend-only

Help:
  ./deploy.sh --help

================================================================================
                        DEPLOYMENT FLOW
================================================================================

START: Make code changes in src/daopad/
  |
  +-> cd src/daopad/
  |
  +-> ./deploy.sh --network ic
  |
  +-> [Parse arguments, check network]
  |
  +-> [If backend changed]
  |   +-> cargo build --target wasm32-unknown-unknown --release -p daopad_backend
  |   +-> candid-extractor (generate .did file)
  |   +-> dfx deploy --network ic daopad_backend
  |   +-> cp declarations to frontend (CRITICAL SYNC)
  |
  +-> [If frontend changed]
  |   +-> npm install
  |   +-> dfx generate daopad_backend (sync with backend)
  |   +-> npm run build
  |   +-> dfx deploy --network ic daopad_frontend
  |
  +-> [Show deployment summary]
  |
  +-> [Optional: --test flag]
      +-> Run smoke tests on backend methods
      +-> Run frontend integration tests
  |
  +-> SUCCESS: All canisters deployed and in sync
  |
  +-> Commit changes and create PR

================================================================================
                      IDENTITY MANAGEMENT
================================================================================

daopad identity:
  - Passwordless (designed for CI/CD and Claude automation)
  - Has admin/operator access to test station
  - Auto-switched to when using --network ic
  - Location: dfx identity store (system-managed)
  - Warning suppression: export DFX_WARNING=-mainnet_plaintext_identity

Current identity:
  - Used for local deployments
  - Must have testnet/mainnet credentials if used

Test Station Access:
  - Station: fec7w-zyaaa-aaaaa-qaffq-cai
  - Token: ALEX
  - Accessible with daopad identity

================================================================================
                    TESTING AND VALIDATION
================================================================================

SMOKE TESTS (after deployment):
  ./deploy.sh --network ic --test
  
  Tests these backend methods:
  - check_admin_control
  - check_treasury_control
  - check_governance_permissions
  - check_proposal_policies
  - check_external_canisters
  - check_asset_management
  - check_system_configuration
  - check_operational_permissions
  - perform_all_security_checks
  - get_orbit_station_for_token
  - get_backend_principal
  - check_backend_status

MANUAL DFX TESTING (before implementation):
  dfx canister --network ic call fec7w-zyaaa-aaaaa-qaffq-cai method_name '(args)'
  
  Rule: Test in dfx FIRST, then implement in code
  If dfx works, code will work (with exact type matching)

DECLARATION VERIFICATION:
  ./scripts/verify-declarations.sh
  
  Checks if frontend and dfx declarations are identical

FRONTEND INTEGRATION TESTS:
  cd src/daopad/daopad_frontend
  npx playwright test

================================================================================
                    SECURITY SAFEGUARDS
================================================================================

1. SPECIFIED CANISTER IDS
   - Prevents accidental deployment to wrong canisters
   - All critical canisters have explicit IDs in dfx.json

2. ROLE SEPARATION
   - Backend (operator) creates requests only
   - Admin (admin) approves requests only
   - Frontend is asset canister only
   - Prevents approval of own requests

3. TEST STATION VALIDATION
   - Test with fec7w-zyaaa-aaaaa-qaffq-cai before live changes
   - daopad identity has admin access
   - 4-step deterministic process: Research -> Test -> Implement -> Verify

4. DECLARATION SYNC ENFORCEMENT
   - Auto-sync in deploy script prevents "not a function" errors
   - Verification script checks for mismatches

5. GITHUB WORKFLOW CHECKS
   - Code review before merging
   - No automatic deployment (manual via ./deploy.sh)

================================================================================
                    COMMON ISSUES & FIXES
================================================================================

Issue: "TypeError: actor.method_name is not a function"
Fix:   cp -r src/declarations/daopad_backend/* src/daopad/daopad_frontend/src/declarations/daopad_backend/
       ./deploy.sh --network ic --frontend-only

Issue: "DFX command not found"
Fix:   Install DFX: sh -c '$(curl -fsSL https://sdk.dfinity.org/install.sh)'

Issue: "dfx is not running" (local only)
Fix:   dfx start --background --host 127.0.0.1:4943

Issue: "Identity not found: daopad"
Fix:   Must be set up separately (not automated)

Issue: Deployment fails with permission error on mainnet
Fix:   Ensure daopad identity has admin/operator roles on test station

Issue: Frontend shows old UI after backend changes
Cause: Declaration sync not completed
Fix:   Run verify-declarations.sh to check, then re-deploy frontend

================================================================================
                  DEPLOYMENT DECISION TREE
================================================================================

         Changed code in src/daopad/
              |
              v
    ./deploy.sh --network ic
         |         |
    Backend?   Frontend?
    /  |  \   /  |  \
   Y   N   Y Y   N   Y
   |       | |       |
   [A]     | | [B]   |
      \    | |    \ /
       \   | |     C (sync + both)
        v  | |    /
      Sync | |   /
      Decl | |  /
       v v v v
    deploy --network ic
       |
       v
    ./deploy.sh --network ic --test
       |
       +--Tests pass?--Y--> SUCCESS (commit + PR)
       |
       +--N--> Fix issue, GOTO "Changed code"

================================================================================

Key Takeaway: Every code change goes directly to production mainnet.
Local testing is NOT supported. Verification happens through post-deployment
tests. This maximizes frontend-backend sync confidence.

